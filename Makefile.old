
.PHONY: help up down restart logs setup migrate makemigrations seed \
        test clean shell psql redis-cli mongo-shell dev fresh

# or make PY ?= python3
PY := backend/myhours-backend/venv/bin/python

#  help 
help:
	@echo "MyHours Development Commands:"
	@echo "=============================="
	@echo "make up          - Start all Docker services"
	@echo "make down        - Stop all Docker services"
	@echo "make restart     - Restart all services"
	@echo "make logs        - View Docker logs"
	@echo "make setup       - Full setup (containers + database)"
	@echo "make migrate     - Run Django migrations"
	@echo "make seed        - Load test data"
	@echo "make test        - Run tests"
	@echo "make clean       - Clean up containers and volumes"
	@echo "make shell       - Django shell"
	@echo "make psql        - PostgreSQL shell"

# Docker
up:
	docker compose up -d
	@echo "✅ Services started. Waiting for databases to be ready..."
	@sleep 5
	@echo "📊 PostgreSQL: http://localhost:5432"
	@echo "📦 Redis: http://localhost:6379"
	@echo "🍃 MongoDB: http://localhost:27017"

down:
	docker compose down

restart: down up

logs:
	docker compose logs -f

clean:
	docker compose down -v
	@echo "✅ All containers and volumes removed"

# DB / Django
migrate:
	$(PY) backend/myhours-backend/manage.py migrate

makemigrations:
	$(PY) backend/myhours-backend/manage.py makemigrations

seed:
	$(PY) backend/myhours-backend/scripts/setup_database.py

setup: up
	@echo "⏳ Waiting for services to be ready..."
	@sleep 10
	@echo "🔄 Running migrations..."
	@$(MAKE) migrate
	@echo "🌱 Seeding database..."
	@$(MAKE) seed
	@echo "✅ Setup complete!"

# django utilits
shell:
	cd backend/myhours-backend && $(PY) manage.py shell

runserver:
	cd backend/myhours-backend && ./venv/bin/python manage.py runserver 0.0.0.0:8000

test:
	cd backend/myhours-backend && $(PY) manage.py test

# shell DB
psql:
	docker exec -it myhours_postgres psql -U myhours_user -d myhours_db

redis-cli:
	docker exec -it myhours_redis redis-cli -a redis_password_123

mongo-shell:
	docker exec -it myhours_mongodb mongosh -u mongo_admin -p mongo_password_123 --authenticationDatabase admin

# shortcuts
dev: up runserver

fresh: clean setup